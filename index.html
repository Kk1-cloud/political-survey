<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Political Orientation Survey</title>
  <style>
    :root {
      --bg: #f5f7f8;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #5b6773;
      --grid: #d7dde3;
      --axis: #8c98a4;
      --accent: #1e7f8d;
      --accent-soft: #d9eef1;
      --warn: #a16207;
      --warn-bg: #fffbeb;
      --shadow: 0 8px 24px rgba(31, 41, 51, 0.08);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans", "Helvetica Neue", Arial, sans-serif;
      color: var(--text);
      background:
        linear-gradient(135deg, #f7f9fa 0%, #eef3f5 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      width: 100%;
      max-width: 920px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .lang-btn, .btn {
      border: 1px solid #c8d2dc;
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: 0.18s ease;
    }

    .lang-btn:hover, .btn:hover { border-color: var(--accent); }

    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .btn.primary:hover { filter: brightness(0.95); }

    .progress-wrap {
      margin: 18px 0 20px;
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.92rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .progress {
      width: 100%;
      height: 10px;
      background: #e7edf2;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > div {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #2d8e9c 0%, #1e7f8d 100%);
      transition: width 0.25s ease;
    }

    .question-card {
      border: 1px solid #e2e8ef;
      border-radius: 12px;
      padding: 18px;
      background: #fbfcfd;
    }

    .qid { display: none; }

    .qtext {
      margin: 0;
      font-size: 1.08rem;
      line-height: 1.45;
    }

    .skip-note {
      margin: 12px 0 0;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .likert {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }

    .likert button {
      border: 1px solid #c9d3dc;
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 12px 6px;
      font-size: 0.95rem;
      cursor: pointer;
      min-height: 54px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 2px;
    }

    .likert button small {
      color: var(--muted);
      font-size: 0.7rem;
      line-height: 1.1;
    }

    .likert button.selected {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #0c4f5a;
      font-weight: 600;
    }

    .actions {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .warn {
      margin-top: 16px;
      border: 1px solid #f2d38b;
      background: var(--warn-bg);
      color: #854d0e;
      border-radius: 12px;
      padding: 12px;
      font-size: 0.95rem;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 16px;
      margin-top: 14px;
    }

    .panel {
      border: 1px solid #e2e8ef;
      border-radius: 12px;
      padding: 14px;
      background: #fbfcfd;
    }

    .panel h3 {
      margin: 0 0 10px;
      font-size: 1rem;
    }

    .metrics {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 8px;
      font-size: 0.95rem;
    }

    .metrics strong { color: #0c4f5a; }

    .v-bar-wrap {
      margin-top: 12px;
    }

    .v-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.84rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .v-bar {
      position: relative;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #eef3f7 0%, #d9e8ef 100%);
      border: 1px solid #cfdae3;
    }

    .v-marker {
      position: absolute;
      top: -4px;
      width: 3px;
      height: 22px;
      background: var(--accent);
      border-radius: 2px;
      transform: translateX(-50%);
    }

    .result-actions {
      margin-top: 18px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .copied {
      margin-top: 8px;
      color: #0c6b3f;
      font-size: 0.9rem;
      min-height: 1.1em;
    }

    .hidden { display: none !important; }

    canvas {
      width: 100%;
      max-width: 100%;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #d8e1e8;
    }

    body.fa {
      direction: rtl;
      font-family: "Vazirmatn", "Tahoma", "Noto Sans Arabic", sans-serif;
    }

    body.fa .progress-meta,
    body.fa .topbar,
    body.fa .actions,
    body.fa .result-actions,
    body.fa .v-labels {
      direction: rtl;
    }

    @media (max-width: 820px) {
      body { padding: 12px; }
      .card { padding: 16px; }
      .likert {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      .results-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="topbar">
        <div>
          <h1 id="title"></h1>
          <p class="subtitle" id="subtitle"></p>
        </div>
        <button id="langBtn" class="lang-btn" type="button"></button>
      </div>

      <section id="surveyView">
        <div class="progress-wrap">
          <div class="progress-meta">
            <span id="counter"></span>
            <span id="blockName" class="hidden"></span>
          </div>
          <div class="progress"><div id="progressBar"></div></div>
        </div>

        <div class="question-card">
          <div class="qid" id="qid"></div>
          <p class="qtext" id="qtext"></p>
          <p class="skip-note" id="skipNote"></p>
          <div class="likert" id="likert"></div>
        </div>

        <div class="actions">
          <button id="backBtn" class="btn" type="button"></button>
          <div style="display:flex; gap:10px;">
            <button id="skipBtn" class="btn" type="button"></button>
            <button id="nextBtn" class="btn primary" type="button"></button>
          </div>
        </div>
      </section>

      <section id="resultView" class="hidden">
        <h2 id="resultTitle" style="margin: 0 0 6px;"></h2>
        <p id="resultSubtitle" class="subtitle" style="margin-top:0;"></p>

        <div id="attentionWarning" class="warn hidden"></div>

        <div class="results-grid">
          <div class="panel">
            <h3 id="mapTitle"></h3>
            <canvas id="chart" width="520" height="420"></canvas>
            <div class="v-bar-wrap">
              <h3 id="visionTitle" style="margin-top:12px;"></h3>
              <div class="v-labels">
                <span id="vLeftLabel"></span>
                <span id="vRightLabel"></span>
              </div>
              <div class="v-bar">
                <div class="v-marker" id="vMarker"></div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3 id="summaryTitle"></h3>
            <ul class="metrics" id="metrics"></ul>
            <p id="interpretation" style="margin: 12px 0 0; line-height:1.45;"></p>
          </div>
        </div>

        <div class="result-actions">
          <button id="copyBtn" class="btn" type="button"></button>
          <button id="jsonBtn" class="btn" type="button"></button>
          <button id="restartBtn" class="btn primary" type="button"></button>
        </div>
        <div class="copied" id="copiedMsg"></div>
      </section>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "politicalSurveyState_v1";
    const storage = (() => {
      try {
        const k = "__survey_test__";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return localStorage;
      } catch {
        const mem = {};
        return {
          setItem: (k, v) => { mem[k] = String(v); },
          getItem: (k) => Object.prototype.hasOwnProperty.call(mem, k) ? mem[k] : null,
          removeItem: (k) => { delete mem[k]; }
        };
      }
    })();

    const i18n = {
      en: {
        title: "Political Orientation Survey",
        subtitle: "Offline self-assessment with economic, social, and vision dimensions.",
        switchLang: "فارسی",
        qCounter: (i, n) => `Question ${i} of ${n}`,
        blockA: "Economic Items",
        blockB: "Social Items",
        blockC: "Vision Items",
        skipNote: "If you choose Skip, this item will be recorded as Neutral (4).",
        back: "Back",
        skip: "Skip (Neutral)",
        next: "Next",
        finish: "Finish",
        resultTitle: "Your Results",
        resultSubtitle: "These scores are descriptive, not diagnostic.",
        mapTitle: "2D Orientation Map",
        visionTitle: "Vision (separate from 2D map)",
        vLeft: "Unconstrained",
        vRight: "Constrained",
        summaryTitle: "Summary",
        copy: "Copy results",
        exportJson: "Export JSON",
        restart: "Restart",
        copied: "Copied to clipboard.",
        copyFailed: "Could not copy automatically. Please copy manually.",
        attentionWarn: "Attention-check warning: One or more attention checks were not answered as instructed. Interpret results as low-confidence.",
        attentionOk: "Attention checks passed.",
        attentionLow: "Low-confidence (attention checks failed)",
        attentionHigh: "Normal-confidence (attention checks passed)",
        xLabel: "Economic (Left + / Right -)",
        yLabel: "Social (Libertarian + / Authoritarian -)",
        quadLL: "Left-libertarian",
        quadLA: "Left-authoritarian",
        quadRL: "Right-libertarian",
        quadRA: "Right-authoritarian",
        econLeft: "Left-leaning",
        econRight: "Right-leaning",
        center: "Center",
        socialLib: "Libertarian-leaning",
        socialAuth: "Authoritarian-leaning",
        visionCon: "Constrained-leaning",
        visionUncon: "Unconstrained-leaning",
        metricX: "X (Economic)",
        metricY: "Y (Social)",
        metricV: "V (Vision)",
        metricEcon: "Economic orientation",
        metricSoc: "Social orientation",
        metricVis: "Vision orientation",
        metricQuad: "Quadrant",
        metricAttn: "Attention status",
        metricClosest: "Closest tendency",
        interpretation: (e, s, v, q, c) => `Interpretation: ${e} economically, ${s} socially, and ${v} in vision. Overall map position: ${q}. Your orientation is closest to ${c}.`,
        closeAncap: "anarcho-capitalism",
        closeLibSoc: "libertarian socialism",
        closeSocDem: "social democracy",
        closeStateSoc: "state socialism",
        closeConservative: "conservative traditionalism",
        closeClassicalLib: "classical liberalism",
        closeCentrism: "mixed centrism",
        likert: {
          1: "Strongly disagree",
          2: "Disagree",
          3: "Slightly disagree",
          4: "Neutral",
          5: "Slightly agree",
          6: "Agree",
          7: "Strongly agree"
        },
        axisLabels: {
          leftPlus: "Left (+)",
          rightMinus: "Right (-)",
          topPlus: "Libertarian (+)",
          bottomMinus: "Authoritarian (-)"
        },
        acA: "Attention check: Select 'Disagree' for this item.",
        acB: "Attention check: Select 'Disagree' for this item."
      },
      fa: {
        title: "پرسشنامه جهت‌گیری سیاسی",
        subtitle: "ارزیابی آفلاین در سه بُعد اقتصادی، اجتماعی و نگرشی.",
        switchLang: "English",
        qCounter: (i, n) => `سوال ${i} از ${n}`,
        blockA: "گویه‌های اقتصادی",
        blockB: "گویه‌های اجتماعی",
        blockC: "گویه‌های نگرشی",
        skipNote: "اگر «رد کردن» را بزنید، این سوال با مقدار خنثی (4) ثبت می‌شود.",
        back: "قبلی",
        skip: "رد کردن (خنثی)",
        next: "بعدی",
        finish: "پایان",
        resultTitle: "نتایج شما",
        resultSubtitle: "این نمره‌ها توصیفی هستند و تشخیص قطعی نیستند.",
        mapTitle: "نقشه دوبعدی جهت‌گیری",
        visionTitle: "نگرش (مستقل از نقشه دوبعدی)",
        vLeft: "نامحدود",
        vRight: "محدود",
        summaryTitle: "خلاصه",
        copy: "کپی نتایج",
        exportJson: "خروجی JSON",
        restart: "شروع دوباره",
        copied: "در کلیپ‌بورد کپی شد.",
        copyFailed: "کپی خودکار انجام نشد. لطفاً دستی کپی کنید.",
        attentionWarn: "هشدار توجه: یک یا چند سوال کنترل توجه مطابق دستور پاسخ داده نشده است. نتیجه با اطمینان پایین تفسیر شود.",
        attentionOk: "کنترل توجه تایید شد.",
        attentionLow: "اطمینان پایین (کنترل توجه ناموفق)",
        attentionHigh: "اطمینان عادی (کنترل توجه موفق)",
        xLabel: "اقتصادی (چپ + / راست -)",
        yLabel: "اجتماعی (آزادی‌خواه + / اقتدارگرا -)",
        quadLL: "چپ-آزادی‌خواه",
        quadLA: "چپ-اقتدارگرا",
        quadRL: "راست-آزادی‌خواه",
        quadRA: "راست-اقتدارگرا",
        econLeft: "گرایش به چپ",
        econRight: "گرایش به راست",
        center: "میانه",
        socialLib: "گرایش آزادی‌خواهانه",
        socialAuth: "گرایش اقتدارگرایانه",
        visionCon: "گرایش محدود",
        visionUncon: "گرایش نامحدود",
        metricX: "X (اقتصادی)",
        metricY: "Y (اجتماعی)",
        metricV: "V (نگرش)",
        metricEcon: "جهت‌گیری اقتصادی",
        metricSoc: "جهت‌گیری اجتماعی",
        metricVis: "جهت‌گیری نگرشی",
        metricQuad: "ربع",
        metricAttn: "وضعیت توجه",
        metricClosest: "نزدیک‌ترین گرایش",
        interpretation: (e, s, v, q, c) => `تفسیر: از نظر اقتصادی ${e}، از نظر اجتماعی ${s} و از نظر نگرشی ${v} هستید. موقعیت کلی شما در نقشه: ${q}. جهت‌گیری شما نزدیک به ${c} است.`,
        closeAncap: "آنارکو-کاپیتالیسم",
        closeLibSoc: "سوسیالیسم آزادی‌خواه",
        closeSocDem: "سوسیال‌دموکراسی",
        closeStateSoc: "سوسیالیسم دولتی",
        closeConservative: "سنت‌گرایی محافظه‌کار",
        closeClassicalLib: "لیبرالیسم کلاسیک",
        closeCentrism: "میانه‌گرایی ترکیبی",
        likert: {
          1: "کاملاً مخالف",
          2: "مخالف",
          3: "تا حدی مخالف",
          4: "خنثی",
          5: "تا حدی موافق",
          6: "موافق",
          7: "کاملاً موافق"
        },
        axisLabels: {
          leftPlus: "چپ (+)",
          rightMinus: "راست (-)",
          topPlus: "آزادی‌خواه (+)",
          bottomMinus: "اقتدارگرا (-)"
        },
        acA: "کنترل توجه: برای این سوال گزینه «مخالف» را انتخاب کنید.",
        acB: "کنترل توجه: برای این سوال گزینه «مخالف» را انتخاب کنید."
      }
    };

    const questions = {
      A: [
        ["A1", "Government should guarantee a basic standard of living for all citizens.", "دولت باید حداقل استاندارد زندگی را برای همه شهروندان تضمین کند."],
        ["A2", "High incomes should be taxed at higher rates than middle incomes.", "درآمدهای بالا باید با نرخ بیشتری نسبت به درآمدهای متوسط مالیات بدهند."],
        ["A3", "A competitive private sector usually allocates resources better than government planning.", "بخش خصوصی رقابتی معمولاً منابع را بهتر از برنامه‌ریزی دولتی تخصیص می‌دهد."],
        ["A4", "Regulations on businesses are often necessary to protect the public from harm.", "مقررات‌گذاری بر کسب‌وکارها اغلب برای حفاظت مردم از آسیب ضروری است."],
        ["A5", "Labor unions are generally beneficial for workers and society.", "اتحادیه‌های کارگری معمولاً برای کارگران و جامعه مفید هستند."],
        ["A6", "Privatizing public services usually improves quality and efficiency.", "خصوصی‌سازی خدمات عمومی معمولاً کیفیت و کارایی را بهبود می‌دهد."],
        ["A7", "Large wealth disparities are acceptable if they result from voluntary exchange.", "نابرابری‌های بزرگ ثروت اگر حاصل مبادله داوطلبانه باشند قابل قبول‌اند."],
        ["A8", "Reducing poverty should be a top priority even if it requires higher taxes.", "کاهش فقر باید اولویت اصلی باشد حتی اگر به مالیات بالاتر نیاز داشته باشد."],
        ["A9", "Free trade tends to benefit society overall, even if some industries decline.", "تجارت آزاد در مجموع به نفع جامعه است، حتی اگر برخی صنایع تضعیف شوند."],
        ["A10", "Government should limit monopolies and excessive market power.", "دولت باید انحصارها و قدرت بیش‌ازحد بازار را محدود کند."],
        ["A11", "People should mostly be responsible for their own economic outcomes.", "افراد باید عمدتاً مسئول نتایج اقتصادی خود باشند."],
        ["A12", "Strong social safety nets reduce long-term economic stability.", "شبکه‌های حمایتی اجتماعی قوی، ثبات اقتصادی بلندمدت را کاهش می‌دهند."],
        ["A13", "Public ownership is sometimes the best option for essential utilities (water, power).", "مالکیت عمومی گاهی بهترین گزینه برای خدمات ضروری (آب، برق) است."],
        ["A14", "Minimum wage laws generally do more harm than good.", "قوانین حداقل دستمزد معمولاً بیشتر از فایده، آسیب دارند."],
        ["A15", "The state should invest heavily in education, infrastructure, and research.", "دولت باید در آموزش، زیرساخت و پژوهش سرمایه‌گذاری سنگین انجام دهد."],
        ["A16", "Lower taxes and fewer rules are the best way to grow the economy.", "مالیات کمتر و قوانین محدودتر بهترین راه رشد اقتصاد است."],
        ["A17", "It is unfair that some people inherit large fortunes; inheritance should be taxed heavily.", "این ناعادلانه است که برخی ثروت‌های عظیم به ارث ببرند؛ ارث باید مالیات سنگین داشته باشد."],
        ["A18", "High corporate taxes discourage investment and should be kept low.", "مالیات بالای شرکت‌ها سرمایه‌گذاری را کم می‌کند و باید پایین نگه داشته شود."],
        ["A19", "Healthcare should be treated primarily as a market good, not a guaranteed public service.", "سلامت و درمان باید عمدتاً کالای بازار باشد نه یک خدمت عمومی تضمین‌شده."],
        ["A20", "Markets often fail to price environmental damage; government must intervene.", "بازارها اغلب خسارت زیست‌محیطی را درست قیمت‌گذاری نمی‌کنند؛ دولت باید مداخله کند."],
        ["A21", "Strong welfare programs create dependence and reduce work incentives.", "برنامه‌های رفاهی قوی وابستگی ایجاد کرده و انگیزه کار را کاهش می‌دهند."],
        ["A22", "When employers and workers bargain freely, outcomes are generally fair.", "وقتی کارفرما و کارگر آزادانه مذاکره می‌کنند، نتایج معمولاً منصفانه است."],
        ["A23", "Government should actively reduce inequality, not only reduce poverty.", "دولت باید فعالانه نابرابری را کاهش دهد، نه فقط فقر را."],
        ["A24", "Government spending should be reduced even if it means cutting social programs.", "هزینه‌های دولت باید کاهش یابد حتی اگر به حذف برنامه‌های اجتماعی منجر شود."]
      ],
      B: [
        ["B1", "Adults should be free to live however they want as long as they don’t harm others.", "بزرگسالان باید آزاد باشند هرطور می‌خواهند زندگی کنند تا زمانی که به دیگران آسیب نزنند."],
        ["B2", "Society is becoming too tolerant of behavior that undermines traditional values.", "جامعه نسبت به رفتارهایی که ارزش‌های سنتی را تضعیف می‌کنند بیش از حد مداراگر شده است."],
        ["B3", "Free speech should protect even offensive or unpopular opinions.", "آزادی بیان باید حتی از دیدگاه‌های توهین‌آمیز یا نامحبوب هم محافظت کند."],
        ["B4", "Authorities should have broader powers to maintain public order and safety.", "برای حفظ نظم و امنیت عمومی، مقامات باید اختیارات گسترده‌تری داشته باشند."],
        ["B5", "Personal privacy should rarely be sacrificed, even to fight serious threats.", "حریم خصوصی شخصی حتی برای مقابله با تهدیدهای جدی هم به‌ندرت باید قربانی شود."],
        ["B6", "People should be punished more harshly for breaking rules, even minor ones.", "افراد برای نقض قوانین حتی جزئی باید سخت‌گیرانه‌تر مجازات شوند."],
        ["B7", "Immigration should be more open if newcomers follow the law and contribute.", "اگر مهاجران قانون‌مدار باشند و مشارکت کنند، مهاجرت باید بازتر باشد."],
        ["B8", "Immigration should be restricted to preserve national culture and social cohesion.", "برای حفظ فرهنگ ملی و انسجام اجتماعی، مهاجرت باید محدود شود."],
        ["B9", "Schools should emphasize critical thinking over obedience and discipline.", "مدارس باید تفکر انتقادی را بیش از اطاعت و انضباط تقویت کنند."],
        ["B10", "Schools should emphasize discipline, respect for authority, and traditional norms.", "مدارس باید انضباط، احترام به اقتدار و هنجارهای سنتی را تقویت کنند."],
        ["B11", "The state should not regulate private moral behavior among consenting adults.", "دولت نباید رفتارهای اخلاقی خصوصی میان بزرگسالان رضایتمند را تنظیم کند."],
        ["B12", "The state should enforce moral standards to maintain a healthy society.", "دولت باید برای حفظ جامعه سالم، استانداردهای اخلاقی را اعمال کند."],
        ["B13", "Gender roles are mostly socially constructed and should not limit anyone’s choices.", "نقش‌های جنسیتی عمدتاً ساخته اجتماعی هستند و نباید انتخاب‌های کسی را محدود کنند."],
        ["B14", "Traditional gender roles are important and should be preserved.", "نقش‌های جنسیتی سنتی مهم هستند و باید حفظ شوند."],
        ["B15", "People should have the right to protest even if it disrupts daily life.", "مردم باید حق اعتراض داشته باشند حتی اگر زندگی روزمره را مختل کند."],
        ["B16", "Protests that disrupt daily life should be limited to protect public order.", "برای حفظ نظم عمومی، اعتراضاتی که زندگی روزمره را مختل می‌کنند باید محدود شوند."],
        ["B17", "Criminal justice should focus more on rehabilitation than punishment.", "عدالت کیفری باید بیش از مجازات، بر بازپروری تمرکز کند."],
        ["B18", "Criminal justice should focus more on punishment and deterrence than rehabilitation.", "عدالت کیفری باید بیش از بازپروری، بر مجازات و بازدارندگی تمرکز کند."],
        ["B19", "Religious institutions should have no special influence on government decisions.", "نهادهای دینی نباید نفوذ ویژه‌ای بر تصمیمات دولت داشته باشند."],
        ["B20", "A society is stronger when religion has a meaningful public role.", "وقتی دین نقش عمومی معنادار داشته باشد، جامعه قوی‌تر است."],
        ["B21", "Censorship is sometimes necessary to protect society from harmful ideas.", "سانسور گاهی برای محافظت جامعه از ایده‌های زیان‌آور ضروری است."],
        ["B22", "Censorship is a greater threat than harmful ideas; open debate is better.", "سانسور تهدیدی بزرگ‌تر از ایده‌های زیان‌آور است؛ گفت‌وگوی باز بهتر است."],
        ["B23", "Parents should have broad freedom to choose what their children are taught.", "والدین باید آزادی گسترده‌ای برای انتخاب محتوای آموزشی فرزندان‌شان داشته باشند."],
        ["B24", "The state should set common educational standards even if some parents object.", "دولت باید حتی با وجود مخالفت برخی والدین، استانداردهای آموزشی مشترک تعیین کند."]
      ],
      C: [
        ["C1", "Because people respond to incentives, institutions should assume self-interest rather than ideal behavior.", "چون مردم به مشوق‌ها پاسخ می‌دهند، نهادها باید خودنفعی را مبنا بگیرند نه رفتار ایده‌آل."],
        ["C2", "With enough expertise and good design, most major social problems can be solved.", "با تخصص کافی و طراحی خوب، بیشتر مسائل بزرگ اجتماعی قابل حل هستند."],
        ["C3", "No leader or agency can ever have enough information to run complex systems well.", "هیچ رهبر یا نهادی هرگز اطلاعات کافی برای اداره خوب نظام‌های پیچیده ندارد."],
        ["C4", "Most harmful behavior is a product of environment and can be greatly reduced by changing conditions.", "بیشتر رفتارهای زیان‌آور محصول محیط‌اند و با تغییر شرایط می‌توان آن‌ها را بسیار کاهش داد."],
        ["C5", "In policy, there are usually unavoidable trade-offs rather than true win–win solutions.", "در سیاست‌گذاری، معمولاً موازنه‌های اجتناب‌ناپذیر وجود دارد نه راه‌حل‌های کاملاً برد-برد."],
        ["C6", "A society is just when outcomes are broadly fair, even if rules must be adjusted case-by-case.", "جامعه زمانی عادلانه است که پیامدها در کل منصفانه باشند، حتی اگر قواعد موردی تنظیم شوند."],
        ["C7", "A society is just when rules are applied consistently, even if outcomes differ.", "جامعه زمانی عادلانه است که قواعد به‌طور یکسان اجرا شوند، حتی اگر نتایج متفاوت باشد."],
        ["C8", "Freedom is mainly the absence of coercion by others / government.", "آزادی عمدتاً یعنی نبود اجبار از سوی دیگران یا دولت."],
        ["C9", "Freedom is mainly having real capabilities and opportunities to live well.", "آزادی عمدتاً یعنی داشتن توانایی‌ها و فرصت‌های واقعی برای خوب زیستن."],
        ["C10", "Traditions and evolved norms often contain wisdom we can’t fully explain.", "سنت‌ها و هنجارهای تکامل‌یافته اغلب حکمت‌هایی دارند که کاملاً قابل توضیح نیستند."],
        ["C11", "Traditions often preserve injustice and should be replaced when reason shows better options.", "سنت‌ها اغلب بی‌عدالتی را حفظ می‌کنند و وقتی عقل گزینه بهتر نشان دهد باید جایگزین شوند."],
        ["C12", "Reforms should be gradual because unintended consequences are common.", "اصلاحات باید تدریجی باشند چون پیامدهای ناخواسته رایج‌اند."]
      ]
    };

    const scoringKeys = {
      X: {
        direct: ["A1","A2","A4","A5","A8","A10","A13","A15","A17","A20","A23"],
        reverse: ["A3","A6","A7","A9","A11","A12","A14","A16","A18","A19","A21","A22","A24"]
      },
      Y: {
        direct: ["B1","B3","B5","B7","B9","B11","B13","B15","B17","B19","B22","B23"],
        reverse: ["B2","B4","B6","B8","B10","B12","B14","B16","B18","B20","B21","B24"]
      },
      V: {
        direct: ["C1","C3","C5","C7","C8","C10","C12"],
        reverse: ["C2","C4","C6","C9","C11"]
      }
    };

    const attentionChecks = {
      AC_A: { expected: 2 },
      AC_B: { expected: 2 }
    };

    const state = {
      lang: "en",
      order: [],
      index: 0,
      answers: {},
      finished: false,
      result: null
    };

    const dom = {
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      langBtn: document.getElementById("langBtn"),
      surveyView: document.getElementById("surveyView"),
      resultView: document.getElementById("resultView"),
      counter: document.getElementById("counter"),
      blockName: document.getElementById("blockName"),
      progressBar: document.getElementById("progressBar"),
      qid: document.getElementById("qid"),
      qtext: document.getElementById("qtext"),
      skipNote: document.getElementById("skipNote"),
      likert: document.getElementById("likert"),
      backBtn: document.getElementById("backBtn"),
      skipBtn: document.getElementById("skipBtn"),
      nextBtn: document.getElementById("nextBtn"),
      resultTitle: document.getElementById("resultTitle"),
      resultSubtitle: document.getElementById("resultSubtitle"),
      attentionWarning: document.getElementById("attentionWarning"),
      mapTitle: document.getElementById("mapTitle"),
      chart: document.getElementById("chart"),
      visionTitle: document.getElementById("visionTitle"),
      vLeftLabel: document.getElementById("vLeftLabel"),
      vRightLabel: document.getElementById("vRightLabel"),
      vMarker: document.getElementById("vMarker"),
      summaryTitle: document.getElementById("summaryTitle"),
      metrics: document.getElementById("metrics"),
      interpretation: document.getElementById("interpretation"),
      copyBtn: document.getElementById("copyBtn"),
      jsonBtn: document.getElementById("jsonBtn"),
      restartBtn: document.getElementById("restartBtn"),
      copiedMsg: document.getElementById("copiedMsg")
    };

    function shuffleArray(arr) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function buildOrder() {
      const blockA = shuffleArray(questions.A.map(q => ({ id: q[0], block: "A", en: q[1], fa: q[2], attention: false })));
      const blockB = shuffleArray(questions.B.map(q => ({ id: q[0], block: "B", en: q[1], fa: q[2], attention: false })));
      const blockC = shuffleArray(questions.C.map(q => ({ id: q[0], block: "C", en: q[1], fa: q[2], attention: false })));

      const acA = { id: "AC_A", block: "A", en: i18n.en.acA, fa: i18n.fa.acA, attention: true };
      const acB = { id: "AC_B", block: "B", en: i18n.en.acB, fa: i18n.fa.acB, attention: true };

      blockA.splice(Math.floor(Math.random() * (blockA.length + 1)), 0, acA);
      blockB.splice(Math.floor(Math.random() * (blockB.length + 1)), 0, acB);

      return [...blockA, ...blockB, ...blockC];
    }

    function saveState() {
      storage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const raw = storage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.order) || !parsed.answers) return false;
        Object.assign(state, parsed);
        return true;
      } catch {
        return false;
      }
    }

    function initFresh() {
      state.order = buildOrder();
      state.index = 0;
      state.answers = {};
      state.finished = false;
      state.result = null;
      saveState();
    }

    function setLang(lang) {
      state.lang = lang;
      document.body.classList.toggle("fa", lang === "fa");
      saveState();
      render();
    }

    function currentItem() {
      return state.order[state.index];
    }

    function answerCurrent(value) {
      const item = currentItem();
      state.answers[item.id] = value;
      saveState();
      renderQuestion();
    }

    function goNext() {
      if (state.index < state.order.length - 1) {
        state.index += 1;
        saveState();
        renderQuestion();
      } else {
        finalize();
      }
    }

    function goBack() {
      if (state.index > 0) {
        state.index -= 1;
        saveState();
        renderQuestion();
      }
    }

    function scoreAxis(key) {
      const { direct, reverse } = scoringKeys[key];
      const transformed = [];
      direct.forEach(id => transformed.push(state.answers[id]));
      reverse.forEach(id => transformed.push(8 - state.answers[id]));
      const mean = transformed.reduce((a, b) => a + b, 0) / transformed.length;
      return { raw: mean, final: mean - 4 };
    }

    function classify(val, pos, neg, center) {
      if (Math.abs(val) < 0.5) return center;
      if (val >= 0.5) return pos;
      return neg;
    }

    function getQuadrant(x, y, t) {
      if (x >= 0 && y >= 0) return t.quadLL;
      if (x >= 0 && y < 0) return t.quadLA;
      if (x < 0 && y >= 0) return t.quadRL;
      return t.quadRA;
    }

    function getClosestIdeology(x, y, v, t) {
      if (x <= -1.2 && y >= 1.0) return t.closeAncap;
      if (x >= 1.2 && y >= 1.0) return t.closeLibSoc;
      if (x >= 0.9 && y < 1.0 && y > -1.0) return t.closeSocDem;
      if (x >= 1.0 && y <= -1.0) return t.closeStateSoc;
      if (x < 1.0 && x > -1.0 && y <= -0.9) return t.closeConservative;
      if (x <= -0.9 && y < 0.9 && y > -1.1) return t.closeClassicalLib;
      if (Math.abs(x) < 0.8 && Math.abs(y) < 0.8) {
        if (v >= 0.6) return `${t.closeCentrism} (${t.visionCon})`;
        if (v <= -0.6) return `${t.closeCentrism} (${t.visionUncon})`;
        return t.closeCentrism;
      }
      if (x >= 0 && y >= 0) return t.closeLibSoc;
      if (x >= 0 && y < 0) return t.closeStateSoc;
      if (x < 0 && y >= 0) return t.closeClassicalLib;
      return t.closeConservative;
    }

    function evaluateAttention() {
      let passed = true;
      for (const id of Object.keys(attentionChecks)) {
        if (state.answers[id] !== attentionChecks[id].expected) {
          passed = false;
        }
      }
      return passed;
    }

    function finalize() {
      const x = scoreAxis("X");
      const y = scoreAxis("Y");
      const v = scoreAxis("V");
      const attentionPassed = evaluateAttention();

      state.result = {
        X_raw: x.raw,
        Y_raw: y.raw,
        V_raw: v.raw,
        X: x.final,
        Y: y.final,
        V: v.final,
        attentionPassed,
        timestamp: new Date().toISOString()
      };
      state.finished = true;
      saveState();
      render();
    }

    function round2(n) {
      return Math.round(n * 100) / 100;
    }

    function drawChart(x, y) {
      const ctx = dom.chart.getContext("2d");
      const w = dom.chart.width;
      const h = dom.chart.height;
      const pad = 44;
      const cx = w / 2;
      const cy = h / 2;
      const half = Math.min(w, h) / 2 - pad;
      const t = i18n[state.lang];

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, w, h);

      ctx.strokeStyle = "#d8e1e8";
      ctx.lineWidth = 1;
      for (let i = -3; i <= 3; i++) {
        const gx = cx + (i / 3) * half;
        const gy = cy + (i / 3) * half;
        ctx.beginPath();
        ctx.moveTo(gx, cy - half);
        ctx.lineTo(gx, cy + half);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(cx - half, gy);
        ctx.lineTo(cx + half, gy);
        ctx.stroke();
      }

      ctx.strokeStyle = "#7f8b96";
      ctx.lineWidth = 1.8;
      ctx.beginPath();
      ctx.moveTo(cx, cy - half);
      ctx.lineTo(cx, cy + half);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(cx - half, cy);
      ctx.lineTo(cx + half, cy);
      ctx.stroke();

      ctx.fillStyle = "#52606d";
      ctx.font = state.lang === "fa" ? "13px Tahoma" : "13px Segoe UI";
      ctx.textAlign = "center";
      ctx.fillText(t.axisLabels.leftPlus, cx - half + 38, cy + 20);
      ctx.fillText(t.axisLabels.rightMinus, cx + half - 38, cy + 20);
      ctx.fillText(t.axisLabels.topPlus, cx, cy - half - 12);
      ctx.fillText(t.axisLabels.bottomMinus, cx, cy + half + 18);

      const px = cx - (x / 3) * half;
      const py = cy - (y / 3) * half;

      ctx.fillStyle = "rgba(30,127,141,0.18)";
      ctx.beginPath();
      ctx.arc(px, py, 13, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#1e7f8d";
      ctx.beginPath();
      ctx.arc(px, py, 6, 0, Math.PI * 2);
      ctx.fill();
    }

    function getResultText() {
      const t = i18n[state.lang];
      const { X, Y, V, attentionPassed } = state.result;

      const econ = classify(X, t.econLeft, t.econRight, t.center);
      const soc = classify(Y, t.socialLib, t.socialAuth, t.center);
      const vis = classify(V, t.visionCon, t.visionUncon, t.center);
      const quad = getQuadrant(X, Y, t);
      const closest = getClosestIdeology(X, Y, V, t);

      return {
        econ,
        soc,
        vis,
        quad,
        closest,
        attentionText: attentionPassed ? t.attentionHigh : t.attentionLow,
        interpretation: t.interpretation(econ, soc, vis, quad, closest)
      };
    }

    function copySummary() {
      const t = i18n[state.lang];
      const r = state.result;
      const rt = getResultText();
      const text = [
        `${t.title}`,
        `X (Economic): ${round2(r.X)}`,
        `Y (Social): ${round2(r.Y)}`,
        `V (Vision): ${round2(r.V)}`,
        `${t.metricEcon}: ${rt.econ}`,
        `${t.metricSoc}: ${rt.soc}`,
        `${t.metricVis}: ${rt.vis}`,
        `${t.metricQuad}: ${rt.quad}`,
        `${t.metricClosest}: ${rt.closest}`,
        `${t.metricAttn}: ${rt.attentionText}`,
        `${t.interpretation(rt.econ, rt.soc, rt.vis, rt.quad, rt.closest)}`
      ].join("\n");

      navigator.clipboard.writeText(text).then(() => {
        dom.copiedMsg.textContent = t.copied;
      }).catch(() => {
        dom.copiedMsg.textContent = `${t.copyFailed}\n\n${text}`;
      });
    }

    function exportJson() {
      const payload = {
        lang: state.lang,
        timestamp: state.result.timestamp,
        order: state.order.map(i => i.id),
        responses: state.answers,
        scores: state.result,
        summary: getResultText()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      const date = new Date().toISOString().replace(/[:.]/g, "-");
      a.href = URL.createObjectURL(blob);
      a.download = `political-orientation-result-${date}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function restart() {
      initFresh();
      render();
    }

    function renderQuestion() {
      const t = i18n[state.lang];
      const item = currentItem();
      const total = state.order.length;
      const shownIndex = state.index + 1;

      dom.counter.textContent = t.qCounter(shownIndex, total);
      dom.progressBar.style.width = `${(shownIndex / total) * 100}%`;
      dom.qtext.textContent = state.lang === "en" ? item.en : item.fa;
      dom.skipNote.textContent = t.skipNote;

      dom.likert.innerHTML = "";
      const current = state.answers[item.id];
      for (let i = 1; i <= 7; i++) {
        const b = document.createElement("button");
        b.type = "button";
        if (i === current) b.classList.add("selected");
        const small = document.createElement("small");
        small.textContent = t.likert[i];
        b.innerHTML = `<span>${i}</span>`;
        b.appendChild(small);
        b.addEventListener("click", () => answerCurrent(i));
        dom.likert.appendChild(b);
      }

      dom.backBtn.disabled = state.index === 0;
      dom.nextBtn.textContent = state.index === total - 1 ? t.finish : t.next;
    }

    function renderResult() {
      const t = i18n[state.lang];
      const r = state.result;
      const rt = getResultText();

      dom.resultTitle.textContent = t.resultTitle;
      dom.resultSubtitle.textContent = t.resultSubtitle;
      dom.mapTitle.textContent = t.mapTitle;
      dom.visionTitle.textContent = t.visionTitle;
      dom.vLeftLabel.textContent = t.vLeft;
      dom.vRightLabel.textContent = t.vRight;
      dom.summaryTitle.textContent = t.summaryTitle;

      dom.copyBtn.textContent = t.copy;
      dom.jsonBtn.textContent = t.exportJson;
      dom.restartBtn.textContent = t.restart;

      if (r.attentionPassed) {
        dom.attentionWarning.classList.add("hidden");
      } else {
        dom.attentionWarning.textContent = t.attentionWarn;
        dom.attentionWarning.classList.remove("hidden");
      }

      dom.metrics.innerHTML = [
        `<li><strong>${t.metricX}:</strong> ${round2(r.X)}</li>`,
        `<li><strong>${t.metricY}:</strong> ${round2(r.Y)}</li>`,
        `<li><strong>${t.metricV}:</strong> ${round2(r.V)}</li>`,
        `<li><strong>${t.metricEcon}:</strong> ${rt.econ}</li>`,
        `<li><strong>${t.metricSoc}:</strong> ${rt.soc}</li>`,
        `<li><strong>${t.metricVis}:</strong> ${rt.vis}</li>`,
        `<li><strong>${t.metricQuad}:</strong> ${rt.quad}</li>`,
        `<li><strong>${t.metricClosest}:</strong> ${rt.closest}</li>`,
        `<li><strong>${t.metricAttn}:</strong> ${rt.attentionText}</li>`
      ].join("");

      dom.interpretation.textContent = rt.interpretation;

      const vPos = ((r.V + 3) / 6) * 100;
      dom.vMarker.style.left = `${Math.max(0, Math.min(100, vPos))}%`;

      drawChart(r.X, r.Y);
      dom.copiedMsg.textContent = "";
    }

    function renderShell() {
      const t = i18n[state.lang];
      dom.title.textContent = t.title;
      dom.subtitle.textContent = t.subtitle;
      dom.langBtn.textContent = t.switchLang;
      dom.backBtn.textContent = t.back;
      dom.skipBtn.textContent = t.skip;
      if (!state.finished) {
        dom.nextBtn.textContent = t.next;
      }
    }

    function render() {
      renderShell();
      if (state.finished && state.result) {
        dom.surveyView.classList.add("hidden");
        dom.resultView.classList.remove("hidden");
        renderResult();
      } else {
        dom.resultView.classList.add("hidden");
        dom.surveyView.classList.remove("hidden");
        renderQuestion();
      }
    }

    dom.langBtn.addEventListener("click", () => setLang(state.lang === "en" ? "fa" : "en"));
    dom.backBtn.addEventListener("click", goBack);
    dom.skipBtn.addEventListener("click", () => { answerCurrent(4); goNext(); });
    dom.nextBtn.addEventListener("click", () => {
      const item = currentItem();
      if (state.answers[item.id] == null) {
        answerCurrent(4);
      }
      goNext();
    });
    dom.copyBtn.addEventListener("click", copySummary);
    dom.jsonBtn.addEventListener("click", exportJson);
    dom.restartBtn.addEventListener("click", restart);

    if (!loadState()) {
      initFresh();
    }
    setLang(state.lang || "en");
  </script>
</body>
</html>
